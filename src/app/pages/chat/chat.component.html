<div class="chat-container" *ngIf="room; else noRoomFound">
  <div class="chat-header">
    <div class="header-left">
      <button (click)="goBack()" class="back-btn">← Volver</button>
      <div class="room-info">
        <h2>{{ room.name }}</h2>
        <p class="room-description">{{ room.description }}</p>
      </div>
    </div>
    <div class="header-right">
      <div class="connection-status" [class.websocket]="connectionStatus">
        <span *ngIf="connectionStatus">🟢 Conectado</span>
        <span *ngIf="!connectionStatus">🔴 Desconectado</span>
      </div>
    </div>
  </div>

  <div class="error-banner" *ngIf="error">
    {{ error }}
    <button (click)="error = ''" class="close-error">×</button>
  </div>

  <div class="loading-container" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>Cargando mensajes...</p>
  </div>

  <div class="chat-content" *ngIf="!loading">
    <div class="messages-container" #messagesContainer>
      <div class="messages-list">
        <div class="empty-messages" *ngIf="messages.length === 0">
          <p>Aún no hay mensajes en esta sala.</p>
          <p>¡Sé el primero en decir hola!</p>
        </div>

        <div *ngFor="let message of messages; let i = index">
          <div class="date-divider" *ngIf="isNewDay(i)">
            <span>{{ formatMessageDate(message.created_at) }}</span>
          </div>
          
          <div class="message" [class.own-message]="isOwnMessage(message)">
            <div class="message-bubble">
              <div class="message-header" *ngIf="!isOwnMessage(message)">
                <span class="sender-name">{{ message.sender?.username }}</span>
              </div>
              
              <div class="message-content">
                <a *ngIf="message.file_url" [href]="message.file_url" target="_blank" rel="noopener noreferrer" class="file-link">
                  {{ message.content }}
                </a>
                <span *ngIf="!message.file_url">{{ message.content }}</span>
              </div>

              <div class="message-time">
                {{ formatMessageTime(message.created_at) }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="message-input-container">
      <div class="upload-progress" *ngIf="uploadProgress > 0 && uploadProgress < 100">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="uploadProgress"></div>
        </div>
        <span class="progress-text">Subiendo... {{ uploadProgress }}%</span>
      </div>

      <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="message-form">
        <div class="input-group">
          <input type="file" #fileInput (change)="onFileSelected($event)" style="display: none" id="fileInput">
          
          <button type="button" (click)="fileInput.click()" class="file-btn" [disabled]="!connectionStatus || uploadProgress > 0" title="Adjuntar archivo">📎</button>
          
          <input
            type="text"
            #messageInput
            class="message-input"
            placeholder="Escribe un mensaje..."
            formControlName="content"  
            (keypress)="onKeyPress($event)"
            [disabled]="!connectionStatus"
          />
          
          <button type="submit" class="send-btn" [disabled]="messageForm.invalid || !connectionStatus">📤</button>
        </div>
      </form>
    </div>
  </div>
</div>

<ng-template #noRoomFound>
  <div class="no-room" *ngIf="!loading">
    <h2>Sala no encontrada</h2>
    <p>La sala a la que intentas acceder no existe.</p>
    <button (click)="goBack()" class="back-btn">← Volver a la lista de salas</button>
  </div>
</ng-template>