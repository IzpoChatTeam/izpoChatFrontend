<div class="chat-container" *ngIf="room">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-left">
      <button (click)="goBack()" class="back-btn">
        â† Volver
      </button>
      <div class="room-info">
        <h2>{{ room.name }}</h2>
        <div class="room-details">
          <span class="room-type" [class.private]="room.is_private">
            {{ room.is_private ? 'ğŸ”’ Privada' : 'ğŸŒ PÃºblica' }}
          </span>
          <span class="member-count">ğŸ‘¥ {{ room.members.length }} miembros</span>
        </div>
      </div>
    </div>
    
    <div class="header-right">
      <div class="connection-status" [class.websocket]="isWebSocketConnected" [class.http-fallback]="!isWebSocketConnected">
        <span *ngIf="isWebSocketConnected">ğŸŸ¢ Tiempo Real</span>
        <span *ngIf="!isWebSocketConnected">ğŸŸ¡ HTTP Polling</span>
      </div>
      <div class="online-users">
        <span class="online-count">{{ onlineUsers.length }} en lÃ­nea</span>
      </div>
      <button (click)="leaveRoom()" class="leave-btn" *ngIf="!isUserOwner(room)">
        Salir de la sala
      </button>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-banner" *ngIf="error">
    {{ error }}
    <button (click)="error = ''" class="close-error">Ã—</button>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>Cargando chat...</p>
  </div>

  <!-- Chat Content -->
  <div class="chat-content" *ngIf="!loading">
    
    <!-- Messages Container -->
    <div class="messages-container" #messagesContainer>
      <div class="messages-list">
        
        <!-- Date Separator -->
        <div class="date-separator" *ngFor="let message of messages; let i = index">
          <div class="date-divider" *ngIf="isNewDay(i)">
            {{ formatMessageDate(message.created_at) }}
          </div>
          
          <!-- Message -->
          <div class="message" [class.own-message]="isOwnMessage(message)" [class.other-message]="!isOwnMessage(message)">
            <div class="message-bubble">
              <div class="message-header" *ngIf="!isOwnMessage(message)">
                <span class="sender-name">{{ message.sender.username }}</span>
                <span class="message-time">{{ formatMessageTime(message.created_at) }}</span>
              </div>
              
              <div class="message-content">
                <span *ngIf="!message.file">{{ message.content }}</span>
              </div>
              
              <div class="file-message" *ngIf="message.file" (click)="downloadFile(message.file.id, message.file.original_filename)">
                <div class="file-icon">{{ getFileIcon(message.file.content_type) }}</div>
                <div class="file-info">
                  <div class="file-name">{{ message.file.original_filename }}</div>
                  <div class="file-size">{{ formatFileSize(message.file.file_size) }}</div>
                </div>
                <button class="download-btn" (click)="$event.stopPropagation(); downloadFile(message.file.id, message.file.original_filename)">
                  Descargar
                </button>
              </div>
              
              <div class="message-time-own" *ngIf="isOwnMessage(message)">
                {{ formatMessageTime(message.created_at) }}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Empty State -->
        <div class="empty-messages" *ngIf="messages.length === 0">
          <p>No hay mensajes aÃºn</p>
          <p>Â¡SÃ© el primero en escribir algo!</p>
        </div>
      </div>
      
      <!-- Typing Indicator -->
      <div class="typing-indicator" *ngIf="getTypingText()">
        <div class="typing-bubble">
          <span class="typing-text">{{ getTypingText() }}</span>
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div class="message-input-container">
      <!-- File Upload Progress -->
      <div class="upload-progress" *ngIf="uploadProgress > 0 && uploadProgress < 100">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="uploadProgress"></div>
        </div>
        <span class="progress-text">Subiendo archivo... {{ uploadProgress }}%</span>
      </div>

      <!-- File Input (hidden) -->
      <input 
        type="file" 
        #fileInput 
        (change)="onFileSelected($event)"
        accept="image/*,.pdf,.doc,.docx,.txt,.zip,.rar"
        style="display: none"
      >

      <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="message-form">
        <div class="input-group">
          <!-- File Upload Button -->
          <button
            type="button"
            (click)="fileInput.click()"
            class="file-btn"
            [disabled]="uploadProgress > 0 && uploadProgress < 100"
            title="Subir archivo"
          >
            ğŸ“
          </button>

          <input
            type="text"
            formControlName="message"
            placeholder="Escribe tu mensaje..."
            class="message-input"
            #messageInput
            (input)="onTyping()"
            (keypress)="onKeyPress($event)"
            [disabled]="!isWebSocketConnected && !connectionStatus"
          />
          <button
            type="submit"
            [disabled]="messageForm.invalid || (!isWebSocketConnected && !connectionStatus)"
            class="send-btn"
          >
            ğŸ“¤
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Online Users Sidebar (optional, can be toggled) -->
  <div class="online-users-sidebar" *ngIf="false">
    <h3>Usuarios en lÃ­nea</h3>
    <div class="users-list">
      <div class="user-item" *ngFor="let user of onlineUsers">
        <span class="user-status">ğŸŸ¢</span>
        <span class="user-name">{{ user.username }}</span>
      </div>
    </div>
  </div>
</div>

<!-- No Room Found -->
<div class="no-room" *ngIf="!room && !loading">
  <h2>Sala no encontrada</h2>
  <p>La sala que buscas no existe o no tienes acceso a ella.</p>
  <button (click)="goBack()" class="back-btn">Volver a salas</button>
</div>